<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — ZöD Hub</title>
  <style>
    :root{
      --bg:#fbfbf8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;
      --accent:#0b3b89;
      --danger:#991b1b;
      --ok:#166534;
      --warn:#92400e;
      --radius:18px;
      --shadow:0 10px 28px rgba(2,6,23,.08);
      --shadow2:0 6px 16px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}

    /* NAV */
    .nav{
      position:sticky; top:0; z-index:10;
      background:rgba(251,251,248,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .container{max-width:1200px; margin:0 auto; padding:18px}
    .nav-inner{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .mark{width:34px; height:34px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#0ea5e9); box-shadow:var(--shadow2)}
    .nav-links{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .nav-links a{padding:10px 10px; border-radius:12px; color:var(--muted); font-weight:800}
    .nav-links a:hover{background:#fff; color:var(--text); box-shadow:var(--shadow2)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:14px;
      font-weight:900;
      border:1px solid transparent;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-primary{background:var(--accent); color:#fff; box-shadow:var(--shadow2)}
    .btn-primary:hover{filter:brightness(.96)}
    .btn-outline{background:transparent; border-color:var(--line); color:var(--text)}
    .btn-outline:hover{background:#fff; box-shadow:var(--shadow2)}
    .btn-danger{background:var(--danger); color:#fff; box-shadow:var(--shadow2)}
    .btn-danger:hover{filter:brightness(.96)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    h1,h2,h3{margin:0}
    h1{font-size:28px; letter-spacing:-.02em}
    h2{font-size:18px}
    .sub{color:var(--muted); font-size:13px; margin-top:4px}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      padding:16px;
    }
    .hr{height:1px; background:var(--line); margin:14px 0}
    .meta{color:var(--muted); font-size:13px}

    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:900;
      border:1px solid var(--line);
      background:#fff;
    }
    .badge.ok{border-color:#bbf7d0; background:#f0fdf4; color:var(--ok)}
    .badge.no{border-color:#fecaca; background:#fef2f2; color:var(--danger)}
    .badge.warn{border-color:#fde68a; background:#fffbeb; color:var(--warn)}
    .badge.neutral{border-color:var(--line); background:#fff; color:var(--muted)}

    /* Layout */
    .page-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin:10px 0 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .sidebar{
      position:sticky; top:88px;
      display:grid; gap:12px;
    }

    label{font-weight:900; font-size:13px; display:block; margin-bottom:8px}
    input, select{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font:inherit;
      outline:none;
    }
    input:focus, select:focus{border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-bottom:14px;
    }
    @media (max-width: 980px){ .stats{grid-template-columns: repeat(2, 1fr);} }
    .stat{
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow2);
    }
    .stat .k{color:var(--muted); font-weight:900; font-size:12px}
    .stat .v{font-weight:1000; font-size:22px; margin-top:6px}

    /* Table */
    .tableWrap{
      overflow:auto;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
    }
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{
      position:sticky; top:0;
      background:#fff;
      border-bottom:1px solid var(--line);
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:12px 12px;
      font-weight:1000;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:12px;
      vertical-align:top;
      font-weight:800;
      white-space:nowrap;
    }
    tbody tr:hover{background:#fafafa}
    tbody td .small{display:block; color:var(--muted); font-weight:800; font-size:12px; margin-top:2px; white-space:normal}
    tbody td:last-child{white-space:nowrap}
    .actions{display:flex; gap:8px; justify-content:flex-end}
    .btn-mini{
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
    }

    /* Gate */
    .gate{
      max-width:520px;
      margin:26px auto 0;
      display:grid;
      gap:10px;
    }
    .hide{display:none !important}

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      display:none;
      box-shadow:var(--shadow);
      z-index:20;
    }
    .hint{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      color:var(--muted);
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html"><span class="mark"></span><span>ZöD Hub</span></a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="booking.html">Book</a>
        <a class="btn btn-outline" href="#" id="logoutBtn" style="display:none">Log out</a>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- GATE -->
    <section class="card gate" id="gate">
      <div>
        <h1>Admin Access</h1>
        <div class="sub">Staff sign-in (Supabase Auth). Only approved staff can verify and check-in bookings.</div>
      </div>

      <div class="hr"></div>

      <div>
        <label for="staffEmail">Email</label>
        <input id="staffEmail" type="email" placeholder="staff@zodhub.co" autocomplete="email" />
      </div>

      <div>
        <label for="staffPassword">Password</label>
        <input id="staffPassword" type="password" placeholder="••••••••" autocomplete="current-password" />
      </div>

      <button class="btn btn-primary" id="loginBtn" type="button">Sign in</button>

      <div class="hint">
        <b style="font-size:13px">Security</b><br/>
        <span class="meta">Keep this page out of public navigation. Make sure RLS/RPCs enforce admin-only writes.</span>
      </div>
    </section>

    <!-- APP -->
    <section id="app" class="hide">
      <div class="page-head">
        <div>
          <h1>Admin Dashboard</h1>
          <div class="sub">Verify booking codes • Check-in customers • View today’s activity</div>
        </div>
        <div class="row" style="justify-content:flex-end;max-width:520px">
          <button class="btn btn-outline" id="refreshBtn" type="button">Refresh</button>
          <button class="btn btn-outline" id="clearBtn" type="button">Clear</button>
        </div>
      </div>

      <div class="stats" aria-label="stats">
        <div class="stat">
          <div class="k">Selected date</div>
          <div class="v" id="statDate">—</div>
        </div>
        <div class="stat">
          <div class="k">Bookings</div>
          <div class="v" id="statTotal">0</div>
        </div>
        <div class="stat">
          <div class="k">Checked in</div>
          <div class="v" id="statChecked">0</div>
        </div>
        <div class="stat">
          <div class="k">Not checked in</div>
          <div class="v" id="statNotChecked">0</div>
        </div>
      </div>

      <section class="grid">
        <!-- SIDEBAR -->
        <aside class="sidebar">
          <section class="card">
            <h2>Verify a code</h2>
            <div class="sub">Enter the booking code shown on the customer’s confirmation page.</div>

            <div class="hr"></div>

            <label for="codeInput">Booking code</label>
            <input id="codeInput" class="mono" type="text" placeholder="e.g. ZDH-BB1EC135" />

            <div class="row" style="margin-top:10px">
              <button class="btn btn-primary" id="verifyBtn" type="button">Verify</button>
              <button class="btn btn-outline" id="checkinBtn" type="button" disabled>Check in</button>
            </div>

            <div class="hr"></div>

            <div id="statusBox" class="hint">
              <span class="badge warn">Waiting</span>
              <span> Enter a code to verify.</span>
            </div>
          </section>

          <section class="card">
            <h2>Filters</h2>
            <div class="sub">Select a date and search (name, email, code).</div>
            <div class="hr"></div>

            <label for="listDate">Date</label>
            <input id="listDate" type="date" />

            <div style="height:10px"></div>

            <label for="searchQuery">Search</label>
            <input id="searchQuery" type="text" placeholder="Type to filter…" />

            <div class="hr"></div>

            <div class="hint">
              <b style="font-size:13px">Front desk flow</b><br/>
              <span class="meta">Verify → confirm date validity → check in → seat customer.</span>
            </div>
          </section>
        </aside>

        <!-- MAIN -->
        <section>
          <section class="card" id="resultCard">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
              <h2>Verification result</h2>
              <span class="badge neutral" id="resultState">No result</span>
            </div>

            <div class="hr"></div>

            <div class="row" style="gap:18px">
              <div style="flex:1">
                <div class="meta">Customer</div>
                <div style="font-weight:1000;font-size:18px;margin-top:6px" id="rName">—</div>
                <div class="meta" style="margin-top:6px" id="rEmail">—</div>
                <div class="meta" style="margin-top:10px">Code</div>
                <div class="mono" style="font-weight:1000;font-size:18px;margin-top:6px" id="rCode">—</div>
              </div>

              <div style="flex:1">
                <div class="meta">Booking</div>
                <div style="margin-top:10px;display:grid;gap:8px">
                  <div><span class="meta">Type:</span> <b id="rType">—</b></div>
                  <div><span class="meta">Space:</span> <b id="rSpace">—</b></div>
                  <div><span class="meta">Package:</span> <b id="rPackage">—</b></div>
                  <div><span class="meta">Dates:</span> <b id="rDates">—</b></div>
                  <div><span class="meta">Payment:</span> <b id="rPayment">—</b></div>
                  <div><span class="meta">Check-in:</span> <b id="rCheckin">—</b></div>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="hint">
              <span class="badge neutral" id="ruleBadge">Rule</span>
              <span id="ruleText">Check-in is allowed only when booking is paid, valid today, and not already checked in.</span>
            </div>
          </section>

          <section class="card" style="margin-top:18px">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
              <h2>Bookings list</h2>
              <span class="badge warn" id="listBadge">Loading</span>
            </div>
            <div class="sub" style="margin-top:6px">This list updates for the selected date and search filter.</div>

            <div class="hr"></div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Customer</th>
                    <th>Code</th>
                    <th>Type</th>
                    <th>Space</th>
                    <th>Package</th>
                    <th>Dates</th>
                    <th>Payment</th>
                    <th>Check-in</th>
                    <th style="text-align:right">Action</th>
                  </tr>
                </thead>
                <tbody id="todayRows">
                  <tr><td colspan="9" class="meta" style="padding:14px">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </section>
        </section>
      </section>
    </section>
  </main>

  <div class="toast" id="toast">Done</div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // =========================
    // ADMIN DASHBOARD (PRODUCTION)
    // - Staff login with Supabase Auth
    // - Verify booking_code via RPC: get_booking_by_code(p_code)
    // - Check-in via RPC: check_in_booking(p_code)
    // - List bookings via RPCs: get_bookings_for_date(p_date), search_bookings(p_query, p_date)
    // =========================

    // ✅ Put your real project values
    const SUPABASE_URL = "https://dzazdrpgedrrcnuzgjjc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6YXpkcnBnZWRycmNudXpnampjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjUxOTQsImV4cCI6MjA4MjcwMTE5NH0.8ZRnOiGtyfi5ibmTbKLROnQ4PqBIDvDfeH-mWGUQy_M";

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);
    const toast = el("toast");

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(()=> toast.style.display="none", 1400);
    }

    function safeText(v){ return (v===undefined || v===null || v==="") ? "—" : String(v); }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // Gate
    const gate = el("gate");
    const app = el("app");
    const loginBtn = el("loginBtn");
    const logoutBtn = el("logoutBtn");
    const staffEmail = el("staffEmail");
    const staffPassword = el("staffPassword");

    async function setAuthedFromSession(){
      const { data: { session } } = await sb.auth.getSession();
      const isAuthed = !!session?.user;
      gate.classList.toggle("hide", isAuthed);
      app.classList.toggle("hide", !isAuthed);
      logoutBtn.style.display = isAuthed ? "inline-flex" : "none";
      return isAuthed;
    }

    loginBtn.addEventListener("click", async () => {
      const email = (staffEmail.value || "").trim();
      const password = staffPassword.value || "";
      if(!email || !password){ showToast("Enter email and password"); return; }
      loginBtn.disabled = true;
      try{
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error) throw error;
        await setAuthedFromSession();
        showToast("Welcome");
        await loadList(); // on login
      }catch(e){
        showToast(e.message || String(e));
      }finally{
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      await sb.auth.signOut();
      await setAuthedFromSession();
      showToast("Logged out");
      clearVerifyUI();
    });

    sb.auth.onAuthStateChange(async () => { await setAuthedFromSession(); });

    // Elements
    const refreshBtn = el("refreshBtn");
    const clearBtn = el("clearBtn");

    const codeInput = el("codeInput");
    const verifyBtn = el("verifyBtn");
    const checkinBtn = el("checkinBtn");
    const statusBox = el("statusBox");
    const resultState = el("resultState");

    const rName = el("rName");
    const rEmail = el("rEmail");
    const rCode = el("rCode");
    const rType = el("rType");
    const rSpace = el("rSpace");
    const rPackage = el("rPackage");
    const rDates = el("rDates");
    const rPayment = el("rPayment");
    const rCheckin = el("rCheckin");
    const ruleBadge = el("ruleBadge");
    const ruleText = el("ruleText");

    const listDate = el("listDate");
    const searchQuery = el("searchQuery");
    const todayRows = el("todayRows");
    const listBadge = el("listBadge");

    const statDate = el("statDate");
    const statTotal = el("statTotal");
    const statChecked = el("statChecked");
    const statNotChecked = el("statNotChecked");

    let current = null;

    function setStatus(kind, text){
      const cls = kind === "ok" ? "ok" : kind === "no" ? "no" : "warn";
      const label = kind === "ok" ? "Valid" : kind === "no" ? "Invalid" : "Info";
      statusBox.innerHTML = `<span class="badge ${cls}">${label}</span> <span>${text}</span>`;
    }

    function clearVerifyUI(){
      current = null;
      resultState.className = "badge neutral";
      resultState.textContent = "No result";
      setStatus("warn", "Enter a code to verify.");
      rName.textContent = "—";
      rEmail.textContent = "—";
      rCode.textContent = "—";
      rType.textContent = "—";
      rSpace.textContent = "—";
      rPackage.textContent = "—";
      rDates.textContent = "—";
      rPayment.textContent = "—";
      rCheckin.textContent = "—";
      ruleBadge.className = "badge neutral";
      ruleBadge.textContent = "Rule";
      ruleText.textContent = "Check-in is allowed only when booking is paid, valid today, and not already checked in.";
      checkinBtn.disabled = true;
    }

    function normalize(b){
      if(!b) return null;
      return {
        booking_code: b.booking_code ?? b.bookingCode ?? "",
        customer_name: b.customer_name ?? b.customerName ?? "",
        customer_email: b.customer_email ?? b.customerEmail ?? "",
        status: b.status ?? "",
        space_type: (b.space_type ?? b.spaceType ?? b.kind ?? "").toString().toLowerCase(),
        space_code: b.space_code ?? b.spaceCode ?? "—",
        package: b.package ?? b.package_name ?? b.packageName ?? "—",
        start_date: (b.start_date ?? b.startDate ?? "").slice(0,10),
        end_date: (b.end_date ?? b.endDate ?? "").slice(0,10),
        checked_in: !!(b.checked_in ?? b.checkedIn),
        checked_in_at: b.checked_in_at ?? b.checkedInAt ?? null,
      };
    }

    function renderVerify(b){
      current = b;

      if(!b){ clearVerifyUI(); return; }

      const isPaid = ["paid","confirmed"].includes(String(b.status || "").toLowerCase());
      const isChecked = !!(b.checked_in || b.checked_in_at);

      const start = b.start_date || "";
      const end = b.end_date || start;
      const today = todayISO();
      const dateOk = (!!start && !!end) ? (today >= start && today <= end) : (start === today);

      rName.textContent = safeText(b.customer_name);
      rEmail.textContent = safeText(b.customer_email);
      rCode.textContent = safeText(b.booking_code);

      if(b.space_type === "general" || String(b.space_code||"").toUpperCase().startsWith("G")){
        rType.textContent = "General Space";
      } else if(b.space_type === "private" || String(b.space_code||"").toUpperCase().startsWith("P")){
        rType.textContent = "Private Space";
      } else {
        rType.textContent = safeText(b.space_type) || "—";
      }
      rSpace.textContent = safeText(b.space_code);
      rPackage.textContent = safeText(b.package);
      rDates.textContent = start ? (start === end ? start : `${start} → ${end}`) : "—";

      rPayment.textContent = isPaid ? "paid" : safeText(b.status || "—");
      rCheckin.textContent = isChecked ? `checked in ${b.checked_in_at ? "(" + new Date(b.checked_in_at).toLocaleString() + ")" : ""}` : "not checked in";

      // Rule + result
      if(!isPaid){
        setStatus("no", "Payment not confirmed.");
        resultState.className = "badge no";
        resultState.textContent = "Not paid";
        ruleBadge.className = "badge no";
        ruleBadge.textContent = "Blocked";
        ruleText.textContent = "Customer must pay before check-in.";
        checkinBtn.disabled = true;
        return;
      }

      if(isChecked){
        setStatus("warn", "Already checked in.");
        resultState.className = "badge warn";
        resultState.textContent = "Already checked";
        ruleBadge.className = "badge warn";
        ruleBadge.textContent = "Blocked";
        ruleText.textContent = "This booking has already been checked in.";
        checkinBtn.disabled = true;
        return;
      }

      if(!dateOk){
        setStatus("warn", `Not valid today. Booking date is ${start}${end && end!==start ? ` → ${end}` : ""}.`);
        resultState.className = "badge warn";
        resultState.textContent = "Wrong date";
        ruleBadge.className = "badge warn";
        ruleBadge.textContent = "Blocked";
        ruleText.textContent = "Check-in only on the valid booking date range.";
        checkinBtn.disabled = true;
        return;
      }

      setStatus("ok", "Booking is valid. You may check in.");
      resultState.className = "badge ok";
      resultState.textContent = "Valid";
      ruleBadge.className = "badge ok";
      ruleBadge.textContent = "Allowed";
      ruleText.textContent = "Paid + valid date + not checked in.";
      checkinBtn.disabled = false;
    }

    async function rpc_get_booking_by_code(code){
      const { data, error } = await sb.rpc("get_booking_by_code", { p_code: code });
      if(error) throw error;
      return Array.isArray(data) ? data[0] : data;
    }

    async function rpc_check_in_booking(code){
      const { data, error } = await sb.rpc("check_in_booking", { p_code: code });
      if(error) throw error;
      return data;
    }

    async function doVerify(){
      const isAuthed = await setAuthedFromSession();
      if(!isAuthed){ showToast("Please sign in"); return; }

      const code = (codeInput.value || "").trim().toUpperCase();
      if(!code){ setStatus("warn","Please enter a booking code."); renderVerify(null); return; }

      verifyBtn.disabled = true;
      try{
        const row = await rpc_get_booking_by_code(code);
        if(!row){
          setStatus("no","No matching booking found.");
          renderVerify(null);
          return;
        }
        renderVerify(normalize(row));
        showToast("Verified");
      }catch(e){
        setStatus("no", e.message || String(e));
        renderVerify(null);
      }finally{
        verifyBtn.disabled = false;
      }
    }

    verifyBtn.addEventListener("click", doVerify);
    codeInput.addEventListener("keydown", (e) => { if(e.key === "Enter") doVerify(); });

    checkinBtn.addEventListener("click", async () => {
      if(!current?.booking_code){ showToast("No booking code"); return; }
      checkinBtn.disabled = true;
      try{
        await rpc_check_in_booking(String(current.booking_code).toUpperCase());
        showToast("Checked in");
        // refresh verify
        const row = await rpc_get_booking_by_code(String(current.booking_code).toUpperCase());
        renderVerify(normalize(row));
        // refresh list
        await loadList();
      }catch(e){
        showToast(e.message || String(e));
      }finally{
        // renderVerify controls enable state
      }
    });

    clearBtn.addEventListener("click", () => {
      codeInput.value = "";
      clearVerifyUI();
    });

    refreshBtn.addEventListener("click", async () => {
      await loadList();
      if((codeInput.value||"").trim()) await doVerify();
      showToast("Refreshed");
    });

    // List
    function setStats(rows){
      const d = listDate.value || todayISO();
      statDate.textContent = d;
      const total = (rows||[]).length;
      const checked = (rows||[]).filter(r => !!(r.checked_in ?? r.checkedIn)).length;
      statTotal.textContent = String(total);
      statChecked.textContent = String(checked);
      statNotChecked.textContent = String(Math.max(0, total - checked));
    }

    function rowPaymentBadge(status){
      const s = String(status||"").toLowerCase();
      if(["paid","confirmed"].includes(s)) return '<span class="badge ok">paid</span>';
      return '<span class="badge warn">'+ (s || "pending") +'</span>';
    }

    function rowCheckinBadge(checked){
      if(checked) return '<span class="badge ok">checked in</span>';
      return '<span class="badge warn">not checked in</span>';
    }

    function renderRows(rows){
      if(!rows || !rows.length){
        todayRows.innerHTML = '<tr><td colspan="9" class="meta" style="padding:14px">No bookings for this date.</td></tr>';
        listBadge.className = "badge warn";
        listBadge.textContent = "Empty";
        setStats([]);
        return;
      }

      setStats(rows);

      listBadge.className = "badge ok";
      listBadge.textContent = "Ready";

      todayRows.innerHTML = rows.map(raw => {
        const b = normalize(raw) || {};
        const isChecked = !!(b.checked_in || b.checked_in_at);
        const action = isChecked
          ? '<span class="badge ok">checked in</span>'
          : `<button class="btn btn-primary btn-mini" data-checkin="${b.booking_code}">Check in</button>`;

        return `
          <tr>
            <td>
              ${safeText(b.customer_name)}
              <span class="small">${safeText(b.customer_email)}</span>
            </td>
            <td class="mono">${safeText(b.booking_code)}</td>
            <td>${safeText(b.space_type ? (b.space_type[0].toUpperCase()+b.space_type.slice(1)) : "—")}</td>
            <td>${safeText(b.space_code)}</td>
            <td>${safeText(b.package)}</td>
            <td>${b.start_date ? (b.start_date === (b.end_date || b.start_date) ? b.start_date : `${b.start_date} → ${b.end_date}`) : "—"}</td>
            <td>${rowPaymentBadge(b.status)}</td>
            <td>${rowCheckinBadge(isChecked)}</td>
            <td style="text-align:right">
              <div class="actions">${action}</div>
            </td>
          </tr>
        `;
      }).join("");

      todayRows.querySelectorAll("[data-checkin]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const code = btn.getAttribute("data-checkin");
          if(!code) return;
          btn.disabled = true;
          const prev = btn.textContent;
          btn.textContent = "Checking…";
          try{
            await rpc_check_in_booking(String(code).toUpperCase());
            showToast("Checked in");
            await loadList();
            // keep verify panel synced
            const typed = (codeInput.value||"").trim().toUpperCase();
            if(typed && typed === String(code).toUpperCase()){
              await doVerify();
            }
          }catch(e){
            showToast(e.message || String(e));
          }finally{
            btn.disabled = false;
            btn.textContent = prev;
          }
        });
      });
    }

    async function loadList(){
      const isAuthed = await setAuthedFromSession();
      if(!isAuthed) return;

      const d = listDate.value || todayISO();
      const q = (searchQuery.value || "").trim();

      listBadge.className = "badge warn";
      listBadge.textContent = "Loading";
      todayRows.innerHTML = '<tr><td colspan="9" class="meta" style="padding:14px">Loading…</td></tr>';

      try{
        let res;
        if(q){
          res = await sb.rpc("search_bookings", { p_query: q, p_date: d });
        }else{
          res = await sb.rpc("get_bookings_for_date", { p_date: d });
        }
        if(res.error) throw res.error;
        renderRows(res.data || []);
      }catch(e){
        listBadge.className = "badge no";
        listBadge.textContent = "Error";
        todayRows.innerHTML = '<tr><td colspan="9" class="meta" style="padding:14px;color:var(--danger)">' + (e.message || String(e)) + '</td></tr>';
        setStats([]);
      }
    }

    // Init
    listDate.value = todayISO();
    statDate.textContent = listDate.value;

    searchQuery.addEventListener("input", () => {
      // small debounce feel
      clearTimeout(window.__t);
      window.__t = setTimeout(loadList, 200);
    });
    listDate.addEventListener("change", loadList);

    await setAuthedFromSession();
    clearVerifyUI();
    // load list if already authed
    const authed = await setAuthedFromSession();
    if(authed) await loadList();
  </script>
</body>
</html>
